

--Performancy Analysis--
--Comapring a current value toa  target value
--current measures - target measure
--current ssles-avg ssles
--current year sales-previous year sales
--curent sale -lowest sales
  
 --analyze the yearly performanmce of products by comaparing each product's sales to both its average sales performance and the previoys year's sales--

 
 WITH yearly_product_sales AS (
 SELECT 
 YEAR(f.order_date) AS order_year,
 p.product_name,
 SUM(f.sales_amount) AS current_sales
 FROM gold.fact_sales f
 LEFT JOIN gold.dim_products p
 ON f.product_key = p.product_key
 WHERE f.order_date is not null
 GROUP BY
 YEAR(f.order_date),
 p.product_name
 ) 
 
 SELECT 
 order_year,
 product_name,
 current_sales,
 AVG(current_Sales) OVER (PARTITION BY product_name) avg_Sales,
 current_sales - AVG(current_Sales) OVER (PARTITION BY product_name) as diff_avg,
 CASE WHEN  current_sales - AVG(current_Sales) OVER (PARTITION BY product_name) > 0 THEN 'Above Avg'
 WHEN  current_sales - AVG(current_Sales) OVER (PARTITION BY product_name) < 0 THEN 'below Avg'
 ELSE 'AVG'
  END avg_change,
  --year-over-year-analysis
 LAG(current_sales) OVER( PARTITION BY product_name ORDER BY order_year) py_Sales,
 current_sales - LAG(current_sales) OVER( PARTITION BY product_name ORDER BY order_year) diff_py,
 CASE WHEN  LAG(current_sales) OVER( PARTITION BY product_name ORDER BY order_year) > 0 THEN 'increase'
 WHEN  LAG(current_sales) OVER( PARTITION BY product_name ORDER BY order_year) < 0 THEN 'decrease'
 ELSE 'no change'
  END py_change
 FROM yearly_product_sales
 ORDER BY product_name, order_year
